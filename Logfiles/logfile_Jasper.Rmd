---
title: "Logbook_Jasper"
author: "Jasper Jonker"
date: "2025-04-23"
output: html_document
---
For our school project were are gone do an research like 
(Fibroblast-derived osteoglycin promotes epithelial cell repair)[https://pmc.ncbi.nlm.nih.gov/articles/PMC11937367/].
They are very specific and we are gone a look more global. I will look at the pathway analysis of the transcription.

For this i will use fgsea that is an tool that can be used for this kind of analysis.


First we are going to install it. That do we as follow:
```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("fgsea")
```

After this we read the library in:
```{r}
library(fgsea)
```

After this i am going to use the example data to look how it all works. 

# oefen

```{r}
data(examplePathways)
data(exampleRanks)
```

```{r}
fgseaRes <- fgsea(pathways = examplePathways, 
                  stats    = exampleRanks,
                  minSize  = 15,
                  maxSize  = 500)
fgseaRes
```

```{r}
fgseaRes <- fgsea(pathways = examplePathways, 
                  stats    = exampleRanks,
                  eps      = 0.0,
                  minSize  = 15,
                  maxSize  = 500)

head(fgseaRes[order(pval), ])
```
```{r}
library(data.table)
library(fgsea)
library(ggplot2)
```

```{r}
plotEnrichment(examplePathways[["5990980_Cell_Cycle"]],
               exampleRanks) + labs(title="Programmed Cell Death")

```
```{r}
topPathwaysUp <- fgseaRes[ES > 0][head(order(pval), n=1), pathway]
topPathwaysDown <- fgseaRes[ES < 0][head(order(pval), n=1), pathway]
topPathways <- c(topPathwaysUp, rev(topPathwaysDown))
plotGseaTable(examplePathways[topPathways], exampleRanks, fgseaRes, 
              gseaParam=0.5)
```
## Over-Representation Analysis

```{r}
library(clusterProfiler)
data("gcSample") # data for examples

```

```{r}
# Need to remove duplicates for the examples
all_genes <- unlist(gcSample)
universe <- all_genes[Biobase::isUnique(all_genes)] # all unique genes

# List with only unique genes
gcUnique <- lapply(gcSample, function(group_i) {
  group_i[group_i %in% universe]
})
```


```{r}
# MSigDB R package
library(msigdbr)
msigdbr::msigdbr_collections() # available collections
# Subset to Human GO-BP sets
BP_db <- msigdbr(species = "Homo sapiens", 
                 category = "C5", subcategory = "GO:BP")
head(BP_db)
```

```{r}
# Convert to a list of gene sets
BP_conv <- unique(BP_db[, c("entrez_gene", "gs_exact_source")])
BP_list <- split(x = BP_conv$entrez_gene, f = BP_conv$gs_exact_source)
# First ~6 IDs of first 3 terms
lapply(head(BP_list, 3), head)
```

```{r}
## Cluster GO-BP ORA with fgsea package
library(fgsea)
library(dplyr)

# For each cluster i, perform ORA
fgsea_ora <- lapply(seq_along(gcUnique), function(i) {
  fora(pathways = BP_list, 
       genes = gcUnique[[i]], # genes in cluster i
       universe = universe, # all genes
       minSize = 15, 
       maxSize = 500) %>% 
    mutate(cluster = names(gcUnique)[i]) # add cluster column
}) %>% 
  data.table::rbindlist() %>% # combine tables
  filter(padj < 0.05) %>% 
  arrange(cluster, padj) %>% 
  # Add additional columns from BP_db
  left_join(distinct(BP_db, gs_subcat, gs_exact_source, 
                     gs_name, gs_description),
            by = c("pathway" = "gs_exact_source")) %>% 
  # Reformat descriptions
  mutate(gs_name = sub("^GOBP_", "", gs_name),
         gs_name = gsub("_", " ", gs_name))

# First 6 rows
head(fgsea_ora)
```

```{r}
if(!require(devtools)) install.packages("devtools")
devtools::install_github("sinhrks/ggfortify")
library(ggplot2)
library(ggfortify)
```


```{r}
data <- read.csv("../data/GSE271272_rawcounts.csv", row.names = 1)
head(data)
```


```{r}
t_data = t(data)
```

```{r}
log_data <- log2(t_data +1)
data_scaled <- scale(log_data)
```

```{r}
pca_result <- prcomp(data_scaled, scale. = T)
pca_result
```


```{r}
# Splits sample naam in onderdelen
metadata <- data.frame(
  sample = rownames(t_data),
  groep = sapply(strsplit(rownames(t_data), "_"), `[`, 2),
  celtype = sapply(strsplit(rownames(t_data), "_"), `[`, 3)
)


rownames(metadata) <- metadata$sample
metadata$groep_celtype <- paste(metadata$groep, metadata$celtype, sep = "_")
```

```{r}
autoplot(pca_result,
         data = metadata,
         colour= 'groep',
         x=1,
         y=2
         )+
  ggtitle("celtype")+
  theme_minimal()
```
# Pathway analuse
Nu ga ik bezig met de path way analyse met de deseq2 die ik van Mirte heb gekregen 
```{r}
library(DESeq2)
```

```{r}
rna_seq_data <- read.csv(
  "../data/GSE271272_rawcounts.csv")

head(rna_seq_data)
```
```{r}
cts <- data.frame(rna_seq_data[,-1])
colnames(cts) <- colnames(rna_seq_data)[-1]
row.names(cts) <- rna_seq_data$Sample
cts <- as.matrix(cts)
```

```{r}
sample_names <- c("M1_ctrl_Epcam", "M2_ctrl_Epcam", "M3_ctrl_Epcam", "M4_ctrl_Epcam",
            "M1_EVs_Epcam", "M2_EVs_Epcam", "M3_EVs_Epcam", "M4_EVs_Epcam",
            "M1_SFs_Epcam", "M2_SFs_Epcam", "M3_SFs_Epcam", "M4_SFs_Epcam",
            "M1_OGN_Epcam", "M2_OGN_Epcam", "M3_OGN_Epcam", "M4_OGN_Epcam",
            "M1_ctrl_CCL", "M2_ctrl_CCL", "M3_ctrl_CCL", "M4_ctrl_CCL",
            "M1_EVs_CCL", "M2_EVs_CCL", "M3_EVs_CCL", "M4_EVs_CCL",
            "M1_SFs_CCL", "M2_SFs_CCL", "M3_SFs_CCL", "M4_SFs_CCL",
            "M1_OGN_CCL", "M2_OGN_CCL", "M3_OGN_CCL", "M4_OGN_CCL")

group <- rep(c("control", "extracellular_vesicles", "soluble_factors", "osteoglycin"), each = 4, times = 2)
type <- rep(c("epcam", "ccl"), each = 16)

metadata <- data.frame(group = factor(group), type = type)
rownames(metadata) <- sample_names

head(metadata)
```

```{r}
dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = metadata,
                              design = ~ group)
```


```{r}
dds <- DESeq(dds)
control_vs_extracellular <- results(dds, contrast = c("group", "control", "extracellular_vesicles"))
control_vs_soluble <- results(dds, contrast = c("group", "control", "soluble_factors"))
extracellular_vs_soluble <- results(dds, contrast = c("group", "extracellular_vesicles", "soluble_factors"))
```

Na dat alles kan ik verder. 

```{r}
gene_ranks_crl_extra <- control_vs_extracellular$stat
names(gene_ranks_crl_extra) <- rownames(control_vs_extracellular)
gene_ranks_crl_extra <- sort(gene_ranks_crl_extra, decreasing = TRUE)
head(gene_ranks_crl_extra)


```

```{r}
gene_ranks_crl_sol <- control_vs_soluble$stat
names(gene_ranks_crl_sol) <- rownames(control_vs_soluble)
gene_ranks_crl_sol <- sort(gene_ranks_crl_sol, decreasing = TRUE)
```

```{r}
gene_ranks_extra_sol <- extracellular_vs_soluble$stat
names(gene_ranks_extra_sol) <- rownames(extracellular_vs_soluble)
gene_ranks_extra_sol <- sort(gene_ranks_extra_sol, decreasing = TRUE)
```

```{r}
library(clusterProfiler)
library(org.Mm.eg.db)

gsea_res <- gseGO(geneList = gene_ranks_crl_extra,
                  OrgDb = org.Mm.eg.db,
                  keyType = "SYMBOL",
                  ont = "BP",
                  minGSSize = 10,
                  maxGSSize = 500,
                  pvalueCutoff = 0.05)
```

```{r}
dotplot(gsea_res, showCategory=5, split=".sign") + facet_grid(.~.sign) + theme(axis.text.y = element_text(size = 9))+ labs(title = 'control vs extracellular')
```

```{r}
ridgeplot(gsea_res, fill = "p.adjust")+ theme_minimal() + labs(title = 'control vs extracellular')
```


```{r}
df_genes <- data.frame(
  symbol = names(gene_ranks_crl_extra),
  stat = gene_ranks_crl_extra
)
df_mapped <- df_genes %>%
  left_join(
    AnnotationDbi::select(org.Mm.eg.db,
                          keys = df_genes$symbol,
                          columns = c("ENTREZID", "SYMBOL"),
                          keytype = "SYMBOL"),
    by = c("symbol" = "SYMBOL")
  ) %>%
  filter(!is.na(ENTREZID))


geneList <- df_mapped$stat
names(geneList) <- df_mapped$ENTREZID

```


```{r}
library(pathview)

setwd("imgs_trans/control_vs_extracellular")
# KEGG: Oxidative phosphorylation (mmu00190)
pathview(
  gene.data = geneList,
  pathway.id = "mmu00190",
  species = "mmu",
  kegg.native = TRUE,
  out.suffix = "oxphos"
)

# KEGG: Purine metabolism (mmu00230)
pathview(
  gene.data = geneList,
  pathway.id = "mmu00230",
  species = "mmu",
  kegg.native = TRUE,
  out.suffix = "purine"
)

# KEGG: Translation (mmu03010)
pathview(
  gene.data = geneList,
  pathway.id = "mmu03010",
  species = "mmu",
  kegg.native = TRUE,
  out.suffix = "translation"
)

```


```{r}
gsea_res_2 <- gseGO(geneList = gene_ranks_crl_sol,
                  OrgDb = org.Mm.eg.db,
                  keyType = "SYMBOL",
                  ont = "BP",
                  minGSSize = 10,
                  maxGSSize = 500,
                  pvalueCutoff = 0.05)

```

```{r}
dotplot(gsea_res_2, showCategory=5, split=".sign") + facet_grid(.~.sign) + theme(axis.text.y = element_text(size = 9))+ labs(title = 'Control vs soluble')
```

```{r}
ridgeplot(gsea_res_2, showCategory = 10, fill = "p.adjust")+ theme_minimal()+ labs(title = 'Control vs soluble')
```


```{r}
df_genes_2 <- data.frame(
  symbol = names(gene_ranks_crl_extra),
  stat = gene_ranks_crl_extra
)
df_mapped_2 <- df_genes_2 %>%
  left_join(
    AnnotationDbi::select(org.Mm.eg.db,
                          keys = df_genes$symbol,
                          columns = c("ENTREZID", "SYMBOL"),
                          keytype = "SYMBOL"),
    by = c("symbol" = "SYMBOL")
  ) %>%
  filter(!is.na(ENTREZID))


geneList_2 <- df_mapped_2$stat
names(geneList_2) <- df_mapped_2$ENTREZID
```

```{r}
setwd("imgs_trans/control_vs_soluble")
# Glycolysis (meerdere termen)
pathview(
  gene.data = geneList_2,
  pathway.id = "mmu00010",
  species = "mmu",
  out.suffix = "glycolysis"
)

# Oxidative phosphorylation / NADH regeneration
pathview(
  gene.data = geneList_2,
  pathway.id = "mmu00190",
  species = "mmu",
  out.suffix = "oxphos"
)

# Mitochondrial translation
pathview(
  gene.data = geneList_2,
  pathway.id = "mmu03008",
  species = "mmu",
  out.suffix = "mito_translation"
)

# NF-kappa B signaling
pathview(
  gene.data = geneList_2,
  pathway.id = "mmu04064",
  species = "mmu",
  out.suffix = "nfkb"
)

# Toll-like receptor signaling
pathview(
  gene.data = geneList_2,
  pathway.id = "mmu04620",
  species = "mmu",
  out.suffix = "toll_like"
)

```

```{r}
gsea_res_3 <- gseGO(geneList = gene_ranks_extra_sol,
                  OrgDb = org.Mm.eg.db,
                  keyType = "SYMBOL",
                  ont = "BP",
                  minGSSize = 10,
                  maxGSSize = 500,
                  pvalueCutoff = 0.05)

```

```{r}
dotplot(gsea_res_3, showCategory=5, split=".sign") + facet_grid(.~.sign) + theme(axis.text.y = element_text(size = 9)) + labs(title = 'Extracellular vs soluble')
```

```{r}
ridgeplot(gsea_res_3, showCategory = 10, fill = "p.adjust")+ theme_minimal()+ theme(axis.text.y = element_text(size = 9))+ labs(title = 'Extracellular vs soluble')
```

```{r}
df_genes_3 <- data.frame(
  symbol = names(gene_ranks_crl_extra),
  stat = gene_ranks_crl_extra
)
df_mapped_3 <- df_genes_3 %>%
  left_join(
    AnnotationDbi::select(org.Mm.eg.db,
                          keys = df_genes$symbol,
                          columns = c("ENTREZID", "SYMBOL"),
                          keytype = "SYMBOL"),
    by = c("symbol" = "SYMBOL")
  ) %>%
  filter(!is.na(ENTREZID))


geneList_3 <- df_mapped_3$stat
names(geneList_3) <- df_mapped_3$ENTREZID
```
```{r}
setwd("imgs_trans/extracellular_vs_soluble")

# Ribosome / cytoplasmic translation
pathview(
  gene.data = geneList_3,
  pathway.id = "mmu03010",
  species = "mmu",
  out.suffix = "ribosome"
)

# Mitochondrial translation
pathview(
  gene.data = geneList_3,
  pathway.id = "mmu03008",
  species = "mmu",
  out.suffix = "mito_translation"
)

# Oxidative phosphorylation
pathview(
  gene.data = geneList_3,
  pathway.id = "mmu00190",
  species = "mmu",
  out.suffix = "oxphos"
)

# Purine metabolism
pathview(
  gene.data = geneList_3,
  pathway.id = "mmu00230",
  species = "mmu",
  out.suffix = "purine"
)
```

